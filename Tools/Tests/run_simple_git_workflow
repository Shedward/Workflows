#!/usr/bin/env bash
set -euo pipefail

. "$(dirname "$0")/../Lib/request.sh"

main() {
  echo "Running SimpleGitWorkflow"
  echo

  request GET "/workflows" >/dev/null

  local response
  response="$(request POST "/workflowInstances" '{"workflowId": "SimpleGitWorkflow"}')"

  local id
  id="$(jq -r '.id' <<<"$response")"
  readonly id

  take_transition() {
    local transition="${1:?transition required}"

    request POST "/workflowInstances/$id/takeTransition" \
      "{\"transitionProcessId\":\"$transition\"}" >/dev/null
  }

  take_transition "CreateTempWorkingDirectory"
  take_transition "InitialiseRepository"
  take_transition "WriteReadmeFile"
  take_transition "CommitChanges"
  take_transition "CleanWorkingFolder"

  if request GET "/workflowInstances" \
    | jq -e --arg id "$id" 'any(.[]; .id == $id)' >/dev/null
  then
    echo "Instance still exists"
    exit 1
  fi

  echo
  echo "Finished Successfully"
  echo "---"
}

main "$@"
